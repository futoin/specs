<!DOCTYPE html>
<html>
<head>
<title>ftn8.2_master_auth.md</title>
<link rel="stylesheet" type="text/css" href="../../css/specs.css">
</head><body>
<pre>
FTN8.3: FutoIn Security Concept - Master Key Authentication
Version: 0.2DV
Date: 2017-12-29
Copyright: 2014-2017 FutoIn Project (http://futoin.org)
Authors: Andrey Galkin
</pre>

<h1>CHANGES</h1>
<ul>
<li>v0.2 - 2017-12-29 - Andrey Galkin<ul>
<li>CHANGED: heavily revised &amp; split into sub-specs</li>
</ul>
</li>
<li>v0.1 - 2014-06-03 - Andrey Galkin<ul>
<li>Initial draft</li>
</ul>
</li>
</ul>
<h1>1. Intro</h1>
<p>This sub-specification of <a href="./ftn8_security_concept.html">FTN8</a> covers
more secure Master Key Authentication with dynamically updated shared secrets.</p>
<p>Service is assumed to be a unattended software or equal - high number of
unattended requests.</p>
<h1>2. Concept</h1>
<h2>2.1. Overall idea</h2>
<ol>
<li>Strong symmetric master key is assumed under "Secret".</li>
<li>Use Diffieâ€“Hellman like approach to exchange keys based on temporary
    assymetric key generated by Service.</li>
<li>Ensure assymetric key authenticity based transport security and/or
    existing shared Secret.</li>
<li>Ensure temporary key and new Secret quality by AuthService.</li>
<li>Use one of supported key derivation strategies:<ul>
<li>do not lock on one method</li>
<li>allow tradeoff between performance and extra security at use time</li>
</ul>
</li>
<li>Key exchange interval solely depends on Invoker, but AuthService
    may deactivate too old/too used keys (defined by configuration).</li>
</ol>
<h2>2.2. Secure symmetric key exchange</h2>
<ol>
<li>Service makes initial call:<ul>
<li>generates a temporary assymetric key</li>
<li>requests a new key from AuthService providing:<ul>
<li>the temporary public key for response encryption</li>
<li>current active key ID as part of MAC</li>
</ul>
</li>
</ul>
</li>
<li>AuthService processes the request:<ul>
<li>ensures request is authentic based on MAC signature</li>
<li>generates a new Secret</li>
<li>cleans up old secrets ensuring current active key ID remains</li>
<li>sends back the new key encrypted by the temporary public key</li>
</ul>
</li>
<li>Service processes response:<ul>
<li>decrypts the payload using the temporary private key</li>
<li>injects the new secret key as primary</li>
</ul>
</li>
<li>Service gradually starts using the new Secret</li>
<li>Both the new Secret and the previous Secret are active</li>
</ol>
<p>Goals met:</p>
<ul>
<li>Forward secrecy even if any key gets compromised</li>
<li>Works over unencrypted/untrusted channels, but discouraged</li>
<li>Ensure rolling Secret updates without communication interruptions</li>
<li>AuthService controls Secret quality</li>
<li>Resource-heavy assymetric key generation is responsibility of Service to
    protect AuthService of heavy load</li>
<li>Initiating Service (acting as Invoker) is responsible for periodic key exchange<ul>
<li>It can not do that at all to reduce complexity, if static key is acceptable</li>
<li>It avoids overcomplicating design with AuthService-to-Service callbacks</li>
</ul>
</li>
</ul>
<h2>2.3 "sec" field structured format</h2>
<p class="futoin-schema">Schema: futoin-sec-master-mac</p>

<pre><code>{
    "title" : "FutoIn 'sec' field - Master MAC",
    "type" : "object",
    "additionalProperties" : false,
    "required" : [ "key", "algo", "sig" ],
    "properties" : {
        "key" : {
            "type" : "string",
            "description" : "Unique master key ID"
        },
        "algo" : {
            "type" : "string",
            "description" : "MAC algo name as defined in FTN8"
        },
        "kds" : {
            "type" : "string",
            "description" : "Derived key strategy"
        },
        "prm" : {
            "type" : "string",
            "description" : "KDS parameter, if applicable"
        },
        "sig" : {
            "type" : "string",
            "description" : "Base64 encoded MAC"
        }
    }
}
</code></pre>
<h2>2.4 "sec" field string format</h2>
<p><code>"-mmac:{key}:{algo}:{dks}:{prm}:{sig}"</code></p>
<h2>2.5. Master MAC response "sec" field</h2>
<p>Response must be authenticated by the same Secret and the same hash algorithm
as used for request signing.</p>
<h2>2.6. Master MAC security level</h2>
<p><code>PrivilegedOps</code> security level must be assigned.</p>
<h1>3. Interface</h1>
<h2>3.1. Message authentication</h2>
<p>Provide Master key based authentication to Executor.</p>
<p>It is designed the way when MAC secret is always kept inside AuthService to
minimize risk of exposure.</p>
<pre><code>{
    "iface" : "futoin.auth.master",
    "version" : "{ver}",
    "ftn3rev" : "1.8",
    "imports" : [
        "futoin.ping:1.0",
        "futoin.auth.types:{ver}"
    ],
    "types" : {
        "MACSecField" : {
            "type" : "map",
            "fields" : {
                "key" : "MasterKeyID",
                "algo" : "MACAlgo",
                "kds" : "KeyDerivationStrategy",
                "prm" : {
                    "type" : "Base64",
                    "optional" : true
                },
                "sig" : "MACValue"
            }
        },
        "MessageAuth" : {
            "type" : "map",
            "fields" : {
                "local_id" : "LocalUserID",
                "global_id" : "GlobalUserID"
            }
        }
    },
    "funcs" : {
        "checkMAC" : {
            "params" : {
                "base" : "MACBase",
                "sec" : "MACSecField",
                "source" : "RequestSource"
            },
            "result" : "MessageAuth",
            "throws" : [
                "SecurityError"
            ]
        },
        "genMAC" : {
            "params" : {
                "base" : "MACBase",
                "reqsec" : "MACSecField"
            },
            "result" : "MACSecField",
            "throws" : [
                "SecurityError"
            ]
        }
    },
    "requires" : [
        "SecureChannel"
    ]
}
</code></pre>
<h2>3.2. Key exchange</h2>
<p>Perform periodic secure symmetric Master Secret exchange initiated by Service.</p>
<pre><code>{
    "iface" : "futoin.auth.master.key",
    "version" : "{ver}",
    "ftn3rev" : "1.8",
    "imports" : [
        "futoin.ping:1.0",
        "futoin.auth.types:{ver}"
    ],
    "funcs" : {
        "getNewSecret" : {
            "params" : {
                "type" : "PublicKeyType",
                "pubkey" : "PublicKey"
            },
            "result" : {
                "new_id" : "MasterKeyID",
                "new_ekey" : "EncryptedMasterKey"
            },
            "throws" : [
                "SecurityError"
            ]
        }
    },
    "requires" : [
        "SecureChannel",
        "MessageSignature"
    ]
}
</code></pre>
<h2>3.3. Auto registration</h2>
<p>This interface allow anonymous access and should be disabled by default
configuration.</p>
<p>TBD.</p>
<pre><code>{
    "iface" : "futoin.auth.master.register",
    "version" : "{ver}",
    "ftn3rev" : "1.8",
    "imports" : [
        "futoin.ping:1.0",
        "futoin.auth.types:{ver}"
    ],
    "funcs" : {
    },
    "requires" : [
        "SecureChannel",
        "MessageSignature"
    ]
}
</code></pre>
<h2>3.3. Management</h2>
<p>This one is complementary to "futoin.auth.manage" iface.</p>
<pre><code>{
    "iface" : "futoin.auth.master.manage",
    "version" : "{ver}",
    "ftn3rev" : "1.8",
    "imports" : [
        "futoin.ping:1.0",
        "futoin.auth.types:{ver}"
    ],
    "funcs" : {
        "getNewMasterSecret" : {
            "params" : {
                "user" : "LocalUser"
            },
            "result" : {
                "new_id" : "MasterKeyID",
                "new_key" : "Base64"
            },
            "throws" : [
                "UnknownUser",
                "NotSet"
            ]
        }
    },
    "requires" : [
        "SecureChannel",
        "MessageSignature"
    ]
}
</code></pre>
<p>=END OF SPEC=</p>
</body></html>