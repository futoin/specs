<pre>
FTN8.3: FutoIn Security Concept - Master Key Authentication
Version: 0.2DV
Date: 2017-12-29
Copyright: 2014-2017 FutoIn Project (http://futoin.org)
Authors: Andrey Galkin
</pre>

# CHANGES

* v0.2 - 2017-12-29 - Andrey Galkin
    - CHANGED: heavily revised & split into sub-specs
* v0.1 - 2014-06-03 - Andrey Galkin
    - Initial draft

# 1. Intro

This sub-specification of [FTN8](./ftn8_security_concept.md) covers
more secure Master Key Authentication with dynamically updated shared secrets.

Service is assumed to be a unattended software or equal - high number of
unattended requests.

# 2. Concept

## 2.1. Overall idea

1. Strong symmetric master key is assumed under "Secret".
2. Use Diffieâ€“Hellman like approach to exchange keys based on temporary
    assymetric key generated by Service.
3. Ensure assymetric key authenticity based transport security and/or
    existing shared Secret.
4. Ensure temporary key and new Secret quality by AuthService.
5. Use one of supported key derivation strategies:
    - do not lock on one method
    - allow tradeoff between performance and extra security at use time
6. Key exchange interval solely depends on Invoker, but AuthService
    may deactivate too old/too used keys (defined by configuration).

## 2.2. Secure symmetric key exchange

1. Service makes initial call:
    - generates a temporary assymetric key
    - requests a new key from AuthService providing:
        - the temporary public key for response encryption
        - current active key ID as part of MAC
2. AuthService processes the request:
    - ensures request is authentic based on MAC signature
    - generates a new Secret
    - cleans up old secrets ensuring current active key ID remains
    - sends back the new key encrypted by the temporary public key
3. Service processes response:
    - decrypts the payload using the temporary private key
    - injects the new secret key as primary
4. Service gradually starts using the new Secret
5. Both the new Secret and the previous Secret are active

Goals met:

* Forward secrecy even if any key gets compromised
* Works over unencrypted/untrusted channels, but discouraged
* Ensure rolling Secret updates without communication interruptions
* AuthService controls Secret quality
* Resource-heavy assymetric key generation is responsibility of Service to
    protect AuthService of heavy load
* Initiating Service (acting as Invoker) is responsible for periodic key exchange
    - It can not do that at all to reduce complexity, if static key is acceptable
    - It avoids overcomplicating design with AuthService-to-Service callbacks

## 2.3 "sec" field structured format

`Schema(futoin-sec-master-mac){`

    {
        "title" : "FutoIn 'sec' field - Master MAC",
        "type" : "object",
        "additionalProperties" : false,
        "required" : [ "key", "algo", "sig" ],
        "properties" : {
            "key" : {
                "type" : "string",
                "description" : "Unique master key ID"
            },
            "algo" : {
                "type" : "string",
                "description" : "MAC algo name as defined in FTN8"
            },
            "kds" : {
                "type" : "string",
                "description" : "Derived key strategy"
            },
            "prm" : {
                "type" : "string",
                "description" : "KDS parameter, if applicable"
            },
            "sig" : {
                "type" : "string",
                "description" : "Base64 encoded MAC"
            }
        }
    }

`}Schema`

## 2.4 "sec" field string format

```
    "-mmac:{key}:{algo}:{dks}:{prm}:{sig}"
```

## 2.5. Master MAC response "sec" field

Response must be authenticated by the same Secret and the same hash algorithm
as used for request signing.


## 2.6. Master MAC security level

`PrivilegedOps` security level must be assigned.


# 3. Interface

## 3.1. Message authentication

Provide Master key based authentication to Executor.

It is designed the way when MAC secret is always kept inside AuthService to
minimize risk of exposure.

`Iface{`

    {
        "iface" : "futoin.auth.master",
        "version" : "{ver}",
        "ftn3rev" : "1.8",
        "imports" : [
            "futoin.ping:1.0",
            "futoin.auth.types:{ver}"
        ],
        "types" : {
            "MACSecField" : {
                "type" : "map",
                "fields" : {
                    "key" : "MasterKeyID",
                    "algo" : "MACAlgo",
                    "kds" : "KeyDerivationStrategy",
                    "prm" : {
                        "type" : "Base64",
                        "optional" : true
                    },
                    "sig" : "MACValue"
                }
            },
            "MessageAuth" : {
                "type" : "map",
                "fields" : {
                    "local_id" : "LocalUserID",
                    "global_id" : "GlobalUserID"
                }
            }
        },
        "funcs" : {
            "checkMAC" : {
                "params" : {
                    "base" : "MACBase",
                    "sec" : "MACSecField",
                    "source" : "RequestSource"
                },
                "result" : "MessageAuth",
                "throws" : [
                    "SecurityError"
                ]
            },
            "genMAC" : {
                "params" : {
                    "base" : "MACBase",
                    "reqsec" : "MACSecField"
                },
                "result" : "MACSecField",
                "throws" : [
                    "SecurityError"
                ]
            }
        },
        "requires" : [
            "SecureChannel"
        ]
    }

`}Iface`

## 3.2. Key exchange

Perform periodic secure symmetric Master Secret exchange initiated by Service.

`Iface{`

    {
        "iface" : "futoin.auth.master.key",
        "version" : "{ver}",
        "ftn3rev" : "1.8",
        "imports" : [
            "futoin.ping:1.0",
            "futoin.auth.types:{ver}"
        ],
        "funcs" : {
            "getNewSecret" : {
                "params" : {
                    "type" : "PublicKeyType",
                    "pubkey" : "PublicKey"
                },
                "result" : {
                    "new_id" : "MasterKeyID",
                    "new_ekey" : "EncryptedMasterKey"
                },
                "throws" : [
                    "SecurityError"
                ]
            }
        },
        "requires" : [
            "SecureChannel",
            "MessageSignature"
        ]
    }

`}Iface`

## 3.3. Auto registration

This interface allow anonymous access and should be disabled by default
configuration.

TBD.

`Iface{`

    {
        "iface" : "futoin.auth.master.register",
        "version" : "{ver}",
        "ftn3rev" : "1.8",
        "imports" : [
            "futoin.ping:1.0",
            "futoin.auth.types:{ver}"
        ],
        "funcs" : {
        },
        "requires" : [
            "SecureChannel",
            "MessageSignature"
        ]
    }

`}Iface`

## 3.3. Management

This one is complementary to "futoin.auth.manage" iface.

`Iface{`

    {
        "iface" : "futoin.auth.master.manage",
        "version" : "{ver}",
        "ftn3rev" : "1.8",
        "imports" : [
            "futoin.ping:1.0",
            "futoin.auth.types:{ver}"
        ],
        "funcs" : {
            "getNewMasterSecret" : {
                "params" : {
                    "user" : "LocalUser"
                },
                "result" : {
                    "new_id" : "MasterKeyID",
                    "new_key" : "Base64"
                },
                "throws" : [
                    "UnknownUser",
                    "NotSet"
                ]
            }
        },
        "requires" : [
            "SecureChannel",
            "MessageSignature"
        ]
    }

`}Iface`

[HKDF]: https://tools.ietf.org/html/rfc5869

=END OF SPEC=
